<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Nogizaka46 Premium Sorter</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,600;0,800;1,400&family=Montserrat:wght@300;500;600&family=Noto+Sans+JP:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #7e1083;
            --primary-dark: #4a004e;
            --accent: #d8b4e2;
            --gold: #d4af37;
            --gold-light: #f9f1d8;
            --silver: #a8a9ad;
            --bronze: #cd7f32;
            --text-dark: #2d1b36;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            background: #f3e7f5;
        }

        .bg-animate {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: linear-gradient(-45deg, #ffffff, #f3e5f5, #e1bee7, #fff);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
        }
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 60H0L30 0Z' fill='%237e1083' fill-opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.6; pointer-events: none;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.85); padding: 1rem 0; text-align: center;
            backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.5);
            position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .logo-container { display: inline-block; position: relative; padding-right: 30px; }
        .logo {
            font-family: 'Bodoni Moda', serif; font-weight: 700; font-size: 2rem;
            background: linear-gradient(45deg, var(--primary), #b042b4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: 2px; text-transform: uppercase;
        }
        .logo-triangle {
            position: absolute; right: 0; top: 50%;
            transform: translateY(-50%) rotate(-15deg);
            background: var(--primary); color: white;
            font-size: 0.9rem; font-weight: bold; padding: 2px 6px;
            clip-path: polygon(15% 0, 100% 0, 85% 100%, 0% 100%);
        }

        /* --- LAYOUT --- */
        .container {
            flex: 1; width: 100%; max-width: 1000px; margin: 0 auto; padding: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .screen {
            display: none; flex-direction: column; align-items: center; width: 100%;
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .screen.active { display: flex; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- START SCREEN --- */
        .hero-card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(126, 16, 131, 0.15);
            border-radius: 30px; padding: 40px 20px; text-align: center;
            width: 100%; max-width: 600px; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }
        .hero-title { font-family: 'Bodoni Moda', serif; font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .hero-sub { font-family: 'Montserrat', sans-serif; font-weight: 500; color: #666; letter-spacing: 1px; text-transform: uppercase; font-size: 0.8rem; margin-bottom: 25px; }

        .wall-container {
            width: 100%; margin-bottom: 30px; position: relative; overflow: hidden; padding: 15px 0;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .wall-track { display: flex; gap: 15px; width: max-content; animation: scrollWall 40s linear infinite; }
        .wall-track:hover { animation-play-state: paused; }
        .wall-img {
            width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
            border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .wall-img:hover { transform: scale(1.1); border-color: var(--primary); }
        @keyframes scrollWall { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        .status-badge {
            background: rgba(126, 16, 131, 0.1); color: var(--primary);
            padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;
            margin-bottom: 30px; display: inline-flex; align-items: center; gap: 6px;
        }
        .dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .btn-group { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 280px; }
        .btn-main {
            background: linear-gradient(135deg, var(--primary) 0%, #9c27b0 100%); color: white;
            border: none; padding: 16px 0; font-size: 1rem; font-weight: 700; letter-spacing: 1px;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; width: 100%;
            box-shadow: 0 8px 20px rgba(126, 16, 131, 0.3);
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(126, 16, 131, 0.4); }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        .btn-demo {
            background: transparent; border: 2px solid rgba(126, 16, 131, 0.2); color: var(--primary);
            padding: 12px 0; font-size: 0.85rem; font-weight: 600; border-radius: 50px; cursor: pointer;
            transition: 0.3s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-demo:hover { background: rgba(126, 16, 131, 0.05); border-color: var(--primary); }

        /* --- BATTLE SCREEN --- */
        .progress-wrapper { width: 100%; max-width: 500px; margin-bottom: 30px; flex-shrink: 0; }
        .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.5); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #d56ee6); width: 0%; transition: width 0.3s; }

        .battle-area { display: flex; justify-content: center; width: 100%; align-items: stretch; gap: 40px; }
        .battle-card {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border: 1px solid white; border-radius: 20px; padding: 15px; width: 48%; max-width: 380px;
            cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        }
        .battle-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 40px rgba(126, 16, 131, 0.15); border-color: var(--accent); z-index: 10; }
        
        .battle-card .card-img-frame, .battle-card .card-content { transition: opacity 0.3s ease-out, transform 0.3s ease-out, filter 0.3s ease-out; opacity: 1; transform: scale(1); filter: blur(0); }
        .battle-card.switching .card-img-frame, .battle-card.switching .card-content { opacity: 0; transform: scale(0.95); filter: blur(8px); }

        .card-img-frame { width: 100%; aspect-ratio: 3/4; border-radius: 12px; overflow: hidden; background: #e0dce0; margin-bottom: 15px; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: flex-end; }
        .card-name { font-family: 'Bodoni Moda', serif; font-size: 1.4rem; color: var(--text-dark); font-weight: 700; line-height: 1.1; margin-bottom: 8px; }
        .card-gen { 
            font-size: 0.75rem; color: var(--primary); text-transform: uppercase; font-weight: 600; 
            background: rgba(126, 16, 131, 0.08); padding: 5px 14px; border-radius: 20px;
            display: inline-block; align-self: center; margin-bottom: 15px;
        }
        .btn-profile {
            background: white; border: 1px solid #e0e0e0; color: #666; width: 100%; padding: 10px;
            border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-profile:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .control-row { display: flex; gap: 20px; margin-top: 40px; flex-shrink: 0; }
        .btn-sec {
            background: rgba(255, 255, 255, 0.6); border: 1px solid white; padding: 12px 30px;
            border-radius: 30px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; 
        }
        .btn-sec:hover { background: white; color: var(--primary); transform: translateY(-2px); }

        @media (max-height: 800px) { .battle-card { max-width: 280px; padding: 10px; } .card-name { font-size: 1.2rem; } .battle-area { gap: 20px; } .control-row { margin-top: 20px; } }
        @media (max-height: 650px) { .battle-card { max-width: 180px; padding: 8px; } .card-name { font-size: 1rem; } .logo { font-size: 1.5rem; } .container { padding: 10px; } }

        /* --- RESULTS --- */
        .result-header { font-family:'Bodoni Moda'; color:var(--primary); margin-bottom:30px; font-size:2.5rem; text-align:center; text-shadow: 0 2px 10px rgba(126, 16, 131, 0.1); }
        .result-container { width: 100%; max-width: 550px; margin: 0 auto; padding-bottom: 40px; }

        .result-row {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 16px; padding: 15px 25px; 
            display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.02); margin-bottom: 15px;
            opacity: 0; transform: translateY(20px); border: 1px solid rgba(255,255,255,0.9); transition: transform 0.2s;
        }
        .result-row:hover { transform: scale(1.01); box-shadow: 0 8px 25px rgba(126, 16, 131, 0.08); }
        .result-row.show { animation: slideUpFade 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes slideUpFade { to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 60% { opacity: 1; transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }

        .rank-1 { 
            background: linear-gradient(135deg, #fffbf0 0%, #fff 100%); border: 2px solid var(--gold); padding: 30px 25px; margin-bottom: 30px; 
            transform: scale(1.05); opacity: 0; box-shadow: 0 15px 40px rgba(212, 175, 55, 0.25); position: relative; overflow: hidden;
        }
        .rank-1::before { content: 'üëë'; position: absolute; right: -10px; top: -15px; font-size: 6rem; opacity: 0.08; transform: rotate(20deg); pointer-events: none; }
        .rank-1.show { animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .rank-1 .rank-num { font-size: 2.8rem; background: linear-gradient(45deg, var(--gold), #e6c86e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 5px rgba(212, 175, 55, 0.2); }
        .rank-1 .res-thumb { width: 85px; height: 85px; border: 3px solid var(--gold); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3); }
        .rank-1 .res-name { font-size: 1.5rem; color: #4a3b10; }

        .rank-2 { border-left: 6px solid var(--silver); background: linear-gradient(to right, #fafafa, #fff); }
        .rank-2 .rank-num { color: var(--silver); font-size: 1.8rem; }
        .rank-2 .res-thumb { border-color: var(--silver); }

        .rank-3 { border-left: 6px solid var(--bronze); background: linear-gradient(to right, #fffaf5, #fff); }
        .rank-3 .rank-num { color: var(--bronze); font-size: 1.8rem; }
        .rank-3 .res-thumb { border-color: var(--bronze); }

        .rank-num { font-family: 'Bodoni Moda'; font-size: 1.2rem; font-weight: 700; width: 50px; text-align: center; flex-shrink:0; color: #888; }
        .res-thumb { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; margin: 0 20px; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink:0; }
        .res-info { flex: 1; z-index: 1; }
        .res-name { font-family: 'Bodoni Moda'; font-weight: 700; font-size: 1.1rem; line-height: 1.2; color: var(--text-dark); }
        .res-gen { font-size: 0.75rem; color: #888; margin-top: 4px; font-family: sans-serif; font-weight: 500; }
        .res-score { font-size: 0.85rem; font-weight: 700; color: var(--primary); background: rgba(126, 16, 131, 0.05); padding: 5px 12px; border-radius: 15px; margin-right: 10px; }

        /* --- ACTIONS & RESTART --- */
        .actions-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 40px; }
        .btn-action { padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.3s; border: none; color: white; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-save { background: #333; } .btn-save:hover { background: #000; transform: translateY(-2px); }
        .btn-share { background: #1DA1F2; } .btn-share:hover { background: #0c85d0; transform: translateY(-2px); }

        .restart-container { padding-bottom: 100px; text-align: center; }
        .btn-restart { background: linear-gradient(135deg, var(--primary) 0%, #9c27b0 100%); color: white; border: none; padding: 16px 40px; font-size: 1rem; font-weight: 700; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 25px rgba(126, 16, 131, 0.3); display: inline-block; }
        .btn-restart:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(126, 16, 131, 0.4); }

        /* --- PREMIUM CAPTURE CARD (Hidden) --- */
        #capture-container {
            position: absolute; left: -9999px; top: 0;
            width: 800px; /* 4:5 Ratio Approx */
            background: linear-gradient(135deg, #fffbf5 0%, #f3e7f5 100%);
            padding: 50px; 
            border: 20px solid white; 
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            box-sizing: border-box;
        }
        /* Watermark Overlay */
        #capture-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 60H0L30 0Z' fill='%237e1083' fill-opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.5; pointer-events: none;
        }

        .cap-header { 
            font-family: 'Bodoni Moda'; font-size: 3.5rem; font-weight: 700; 
            color: var(--primary); margin-bottom: 5px; 
            text-shadow: 2px 2px 0 white; position: relative; z-index: 2;
        }
        .cap-sub { 
            font-size: 1.2rem; text-transform: uppercase; letter-spacing: 4px; color: #666; 
            margin-bottom: 40px; position: relative; z-index: 2; font-weight: 600;
        }

        /* Capture Rows */
        .cap-row {
            display: flex; align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 15px 30px; margin-bottom: 15px;
            border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(126, 16, 131, 0.1);
            position: relative; z-index: 2;
        }

        /* Rank 1 Gold Card */
        .cap-row.cap-rank-1 {
            background: linear-gradient(to right, #fff, #fffcf0);
            border: 2px solid var(--gold);
            padding: 25px 30px; margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.2);
        }
        .cap-row.cap-rank-1 .cap-rank { color: var(--gold); font-size: 3rem; }
        .cap-row.cap-rank-1 .cap-img { border-color: var(--gold); width: 90px; height: 90px; }
        .cap-row.cap-rank-1 .cap-name { font-size: 1.8rem; color: #4a3b10; }
        .cap-row.cap-rank-1::after {
            content: 'üëë'; position: absolute; right: 30px; top: -10px; font-size: 3rem; opacity: 0.15; transform: rotate(15deg);
        }

        .cap-row.cap-rank-2 { border-left: 8px solid var(--silver); }
        .cap-row.cap-rank-3 { border-left: 8px solid var(--bronze); }

        .cap-rank { 
            font-family: 'Bodoni Moda'; font-size: 2rem; font-weight: 700; 
            width: 60px; color: #888; margin-right: 25px; 
        }
        .cap-img { 
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover; 
            border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .cap-name { 
            font-family: 'Bodoni Moda'; font-size: 1.5rem; font-weight: 700; 
            color: var(--text-dark); flex: 1; text-align: left; padding-left: 25px; 
        }
        
        /* Capture Score */
        .cap-score {
            font-family: 'Montserrat', sans-serif; font-size: 1.1rem; font-weight: 700;
            color: var(--primary); background: rgba(126, 16, 131, 0.08);
            padding: 6px 15px; border-radius: 20px; margin-left: auto; white-space: nowrap;
        }
        
        .cap-footer { 
            margin-top: 50px; font-size: 1rem; color: var(--primary); 
            border-top: 1px solid rgba(126, 16, 131, 0.2); padding-top: 25px;
            display: flex; justify-content: space-between; align-items: center;
            position: relative; z-index: 2; font-weight: 600;
        }

        /* --- MODAL --- */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 27, 54, 0.6); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-backdrop.active { display: flex; }
        .modal-content { background: #fff; width: 90%; max-width: 380px; border-radius: 24px; overflow: hidden; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { background: linear-gradient(135deg, #fdfbfd 0%, #f4eef5 100%); padding: 30px 20px; text-align: center; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 1.5rem; color: #888; cursor: pointer; }
        .modal-avatar { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; border: 4px solid white; box-shadow: 0 10px 20px rgba(126, 16, 131, 0.15); }
        .modal-tag { font-size: 0.85rem; color: var(--primary); font-weight: 600; background: rgba(126, 16, 131, 0.1); padding: 6px 16px; border-radius: 20px; display: inline-block; }
        .modal-body { padding: 25px; display: grid; gap: 12px; }
        .media-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: all 0.3s ease; background: white; border: 1px solid #ddd; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.03); }
        .btn-google { border-color: #ddd; color: #555; } .btn-google:hover { background: #f8f9fa; border-color: #aaa; transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .btn-pinterest { border-color: #e60023; color: #e60023; } .btn-pinterest:hover { background: #e60023; color: white; transform: translateY(-2px); box-shadow: 0 8px 15px rgba(230, 0, 35, 0.3); }
        .btn-youtube { border-color: #ff0000; color: #ff0000; } .btn-youtube:hover { background: #ff0000; color: white; transform: translateY(-2px); box-shadow: 0 8px 15px rgba(255, 0, 0, 0.3); }

    </style>
</head>
<body>

<div class="bg-animate"></div>
<div class="bg-pattern"></div>

<header>
    <div class="logo-container">
        <div class="logo">Nogizaka</div>
        <div class="logo-triangle">46</div>
    </div>
</header>

<div class="container">

    <!-- START SCREEN -->
    <div id="start-screen" class="screen active">
        <div class="hero-card">
            <h1 class="hero-title">NOGIZAKA</h1>
            <div class="hero-sub">Official Member Sorter</div>
            <div class="wall-container"><div id="wall-track" class="wall-track"></div></div>
            <div id="status" class="status-badge"><span class="dot"></span> Initializing...</div>
            <div class="btn-group">
                <button id="start-btn" class="btn-main" onclick="startSort()" disabled>Start Ranking</button>
                <button id="demo-btn" class="btn-demo" onclick="runDemo()" disabled>‚ö° Instant Demo</button>
            </div>
        </div>
    </div>

    <!-- BATTLE SCREEN -->
    <div id="battle-screen" class="screen">
        <div class="progress-wrapper">
            <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:600; color:#666; margin-bottom:4px;"><span>PROGRESS</span><span id="progress-txt">0%</span></div>
            <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
        </div>
        <div class="battle-area">
            <div class="battle-card" onclick="vote('left')">
                <div class="card-img-frame"><img id="img-left" class="card-img" src="" onerror="handleError(this)"></div>
                <div class="card-content"><div class="card-name" id="name-left">Name</div><div class="card-gen" id="gen-left">Gen</div><button class="btn-profile" onclick="openModal(event, 'left')"><span>‚ú¶</span> Profile & Media</button></div>
            </div>
            <div class="battle-card" onclick="vote('right')">
                <div class="card-img-frame"><img id="img-right" class="card-img" src="" onerror="handleError(this)"></div>
                <div class="card-content"><div class="card-name" id="name-right">Name</div><div class="card-gen" id="gen-right">Gen</div><button class="btn-profile" onclick="openModal(event, 'right')"><span>‚ú¶</span> Profile & Media</button></div>
            </div>
        </div>
        <div class="control-row">
            <button class="btn-sec" onclick="vote('tie')">ü§ù Tie</button>
            <button class="btn-sec" onclick="undo()">‚Ü© Undo</button>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="result-screen" class="screen">
        <h2 class="result-header">Final Ranking</h2>
        
        <div class="result-container" id="result-list"></div>
        
        <!-- Action Buttons -->
        <div class="actions-container">
            <button class="btn-action btn-save" onclick="saveImage()">üì∏ Save Image</button>
            <button class="btn-action btn-share" onclick="shareTwitter()">üê¶ Share on X</button>
        </div>

        <div class="restart-container">
            <button class="btn-restart" onclick="restartSorter()">Sort Again</button>
        </div>
    </div>

</div>

<!-- PREMIUM CAPTURE NODE (Hidden) -->
<div id="capture-container">
    <div class="cap-header">NOGIZAKA</div>
    <div class="cap-sub">Official Top 5 Ranking</div>
    <div id="capture-list"></div>
    <div class="cap-footer">
        <span class="cap-logo-sm">Nogizaka46 Sorter</span>
        <span id="cap-date" style="color:#666; font-weight:400;"></span>
    </div>
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <img id="m-img" class="modal-avatar" src="">
            <h3 id="m-name" style="font-family:'Bodoni Moda'; color:var(--primary); margin-bottom:10px;">Name</h3>
            <div id="m-meta" class="modal-tag">Gen ‚Ä¢ Birthdate</div>
        </div>
        <div class="modal-body">
            <a id="link-google" href="#" target="_blank" class="media-btn btn-google">üîç Google Images</a>
            <a id="link-pinterest" href="#" target="_blank" class="media-btn btn-pinterest">üìå Pinterest</a>
            <a id="link-youtube" href="#" target="_blank" class="media-btn btn-youtube">‚ñ∂ YouTube</a>
        </div>
    </div>
</div>

<script>
    // CONFIG
    const IMG_BASE = "https://n46db.com/pictures/profilepics/";
    const PROXY = "https://api.allorigins.win/get?url=";
    const TARGET = encodeURIComponent("https://n46db.com/");

    let members = [];
    let queue = [];
    let currentMerge = null;
    let history = [];
    let maxBattles = 0;
    let battlesCount = 0;
    let isAnimating = false;
    let finalTop5 = [];

    async function init() {
        const status = document.getElementById('status');
        try {
            const res = await fetch(PROXY + TARGET);
            const json = await res.json();
            if(!json.contents) throw new Error("Empty response");

            const parser = new DOMParser();
            const doc = parser.parseFromString(json.contents, "text/html");
            const rows = Array.from(doc.querySelectorAll('tr'));
            
            const parsed = [];
            rows.forEach(row => {
                const text = row.innerText;
                if ((text.includes("Êúü") || text.includes("Gen")) && /\d{4}\.\d{2}\.\d{2}/.test(text)) {
                    const nameMatch = text.match(/[A-Z]+\s[A-Za-z\s]+/);
                    const dateMatch = text.match(/(\d{4}\.\d{2}\.\d{2})/);
                    if (nameMatch) {
                        let rawName = nameMatch[0].trim();
                        const filename = rawName.toLowerCase().replace(/\s+/g, '_') + ".jpg";
                        const displayName = toTitleCase(rawName);
                        let gen = "Unknown";
                        if (text.includes("3Êúü") || text.includes("3rd")) gen = "3rd Gen";
                        if (text.includes("4Êúü") || text.includes("4th")) gen = "4th Gen";
                        if (text.includes("5Êúü") || text.includes("5th")) gen = "5th Gen";
                        if (text.includes("6Êúü") || text.includes("6th")) gen = "6th Gen";
                        let birthdate = dateMatch ? dateMatch[0] : "Unknown";
                        if (!parsed.find(m => m.name === displayName)) {
                            parsed.push({ name: displayName, gen: gen, date: birthdate, img: IMG_BASE + filename });
                        }
                    }
                }
            });
            members = parsed;
            status.innerHTML = `<span class="dot"></span> ${members.length} Members Loaded`;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('demo-btn').disabled = false;
            
            // Global proxy usage for data consistency
            members.forEach(m => {
                m.img = "https://wsrv.nl/?url=" + encodeURIComponent(m.img) + "&w=400&output=webp";
            });

            initWall();

        } catch (e) {
            status.innerHTML = `‚ö† Fetch Error. Using backup data.`;
            loadBackup();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('demo-btn').disabled = false;
            initWall();
        }
    }

    function initWall() {
        const track = document.getElementById('wall-track');
        if(members.length < 1) return;
        const pool = [...members].sort(()=>0.5-Math.random()).slice(0, 20);
        const wallMembers = [...pool, ...pool]; 
        track.innerHTML = '';
        wallMembers.forEach(m => {
            const img = document.createElement('img');
            img.src = m.img;
            img.className = 'wall-img';
            img.onerror = function(){this.style.display='none'};
            track.appendChild(img);
        });
    }

    function toTitleCase(str) {
        return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function loadBackup() {
        members = [
            {name: "Umezawa Minami", gen: "3rd Gen", date:"1999.01.06", img: IMG_BASE+"umezawa_minami.jpg"},
            {name: "Kaki Haruka", gen: "4th Gen", date:"2001.08.08", img: IMG_BASE+"kaki_haruka.jpg"},
            {name: "Inoue Nagi", gen: "5th Gen", date:"2005.02.17", img: IMG_BASE+"inoue_nagi.jpg"},
            {name: "Endo Sakura", gen: "4th Gen", date:"2001.10.03", img: IMG_BASE+"endo_sakura.jpg"},
            {name: "Yoda Yuuki", gen: "3rd Gen", date:"2000.05.05", img: IMG_BASE+"yoda_yuuki.jpg"}
        ];
        members.forEach(m => {
            m.img = "https://wsrv.nl/?url=" + encodeURIComponent(m.img) + "&w=400&output=webp";
        });
    }

    function startSort() {
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('battle-screen').classList.add('active');
        queue = members.map((_, i) => [i]);
        for (let i = queue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [queue[i], queue[j]] = [queue[j], queue[i]];
        }
        maxBattles = members.length * Math.log2(members.length);
        battlesCount = 0; history = []; currentMerge = null;
        nextBattle();
    }

    function runDemo() {
        if (members.length === 0) return;
        document.getElementById('start-screen').classList.remove('active');
        const demoOrder = members.map((_, i) => i).sort(() => 0.5 - Math.random());
        showResults(demoOrder);
    }

    function nextBattle() {
        if (currentMerge === null) {
            if (queue.length <= 1) { showResults(queue[0] || []); return; }
            let left = queue.shift(); let right = queue.shift();
            currentMerge = { left, right, result: [] };
        }
        if (currentMerge.left.length > 0 && currentMerge.right.length > 0) {
            updateUI(currentMerge.left[0], currentMerge.right[0]);
        } else { finishMerge(); nextBattle(); }
    }

    function finishMerge() {
        while(currentMerge.left.length > 0) currentMerge.result.push(currentMerge.left.shift());
        while(currentMerge.right.length > 0) currentMerge.result.push(currentMerge.right.shift());
        queue.push(currentMerge.result); currentMerge = null;
    }

    function updateUI(id1, id2) {
        battlesCount++;
        const pct = Math.min(100, Math.floor((battlesCount / maxBattles) * 100));
        document.getElementById('progress-fill').style.width = pct + '%';
        document.getElementById('progress-txt').innerText = pct + '%';

        const leftCard = document.querySelectorAll('.battle-card')[0];
        const rightCard = document.querySelectorAll('.battle-card')[1];
        isAnimating = true;
        leftCard.classList.add('switching');
        rightCard.classList.add('switching');

        setTimeout(() => {
            renderCard('left', members[id1]);
            renderCard('right', members[id2]);
            leftCard.classList.remove('switching');
            rightCard.classList.remove('switching');
            setTimeout(() => { isAnimating = false; }, 300);
        }, 300);
    }

    function renderCard(side, member) {
        const img = document.getElementById(`img-${side}`);
        // Reset opacity just in case logic fails
        img.style.opacity = ""; 
        img.src = member.img;
        
        document.getElementById(`name-${side}`).innerText = member.name;
        document.getElementById(`gen-${side}`).innerText = member.gen;
        
        const btn = document.querySelector(`#name-${side}`).parentElement.querySelector('.btn-profile');
        btn.dataset.name = member.name; btn.dataset.gen = member.gen; btn.dataset.date = member.date; btn.dataset.img = member.img;
    }

    function vote(choice) {
        if(isAnimating) return;
        history.push(JSON.parse(JSON.stringify({queue, currentMerge, battlesCount})));
        if (choice === 'left') currentMerge.result.push(currentMerge.left.shift());
        else if (choice === 'right') currentMerge.result.push(currentMerge.right.shift());
        else { currentMerge.result.push(currentMerge.left.shift()); currentMerge.result.push(currentMerge.right.shift()); }
        nextBattle();
    }

    function undo() {
        if(isAnimating) return;
        if (history.length === 0) return;
        const s = history.pop(); queue = s.queue; currentMerge = s.currentMerge; battlesCount = s.battlesCount;
        if (currentMerge && currentMerge.left.length > 0 && currentMerge.right.length > 0) {
            battlesCount--; updateUI(currentMerge.left[0], currentMerge.right[0]);
        } else nextBattle();
    }

    function showResults(list) {
        document.getElementById('battle-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        const c = document.getElementById('result-list');
        c.innerHTML = '';
        const total = list.length;
        finalTop5 = [];

        list.forEach((idx, i) => {
            const m = members[idx];
            const rank = i + 1;
            let score = total > 1 ? Math.round(((total - i) / total) * 100) : 100;
            if (i < 5) finalTop5.push({ rank: rank, name: m.name, img: m.img, score: score });

            const div = document.createElement('div');
            let rowClass = 'result-row';
            if (rank === 1) rowClass += ' rank-1';
            else if (rank === 2) rowClass += ' rank-2';
            else if (rank === 3) rowClass += ' rank-3';

            div.className = rowClass;
            
            let delay = 0;
            if (rank === 1) delay = 100;
            else if (rank === 2) delay = 800;
            else if (rank === 3) delay = 1400;
            else delay = 1800 + ((i - 3) * 100);

            setTimeout(() => { div.classList.add('show'); }, delay);

            div.innerHTML = `
                <div class="rank-num">${rank}</div>
                <img class="res-thumb" src="${m.img}">
                <div class="res-info">
                    <div class="res-name">${m.name}</div>
                    <div class="res-gen" style="font-size:0.7rem; color:var(--primary); background:rgba(126,16,131,0.08); padding:2px 8px; border-radius:10px; display:inline-block; margin-top:4px;">${m.gen}</div>
                </div>
                <div class="res-score">${score} pts</div>
                <button class="btn-profile" style="width:auto; padding:6px 12px; border-radius:50%; margin-left:10px;" data-name="${m.name}" data-gen="${m.gen}" data-date="${m.date}" data-img="${m.img}" onclick="openModal(event)">‚ú¶</button>
            `;
            c.appendChild(div);
        });
    }

    function saveImage() {
        const capList = document.getElementById('capture-list');
        capList.innerHTML = '';
        
        const now = new Date();
        document.getElementById('cap-date').innerText = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        
        finalTop5.forEach(m => {
            let rankClass = '';
            if(m.rank === 1) rankClass = 'cap-rank-1';
            else if(m.rank === 2) rankClass = 'cap-rank-2';
            else if(m.rank === 3) rankClass = 'cap-rank-3';

            // Use high-quality square crop from proxy for final image
            // We already have proxy URL stored in members, but let's ensure high res
            // Extract the original URL from the proxy wrapper if needed, or just reuse
            // Simple trick: Replace width parameter
            const highResImg = m.img.replace("w=400", "w=300&h=300&fit=cover");

            capList.innerHTML += `
                <div class="cap-row ${rankClass}">
                    <div class="cap-rank">${m.rank}</div>
                    <img class="cap-img" src="${highResImg}" crossorigin="anonymous">
                    <div class="cap-name">${m.name}</div>
                    <div class="cap-score">${m.score} pts</div>
                </div>
            `;
        });

        const node = document.getElementById('capture-container');
        
        html2canvas(node, { 
            useCORS: true, 
            scale: 2, 
            backgroundColor: null 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `nogi_top5_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => {
            console.error(err);
            alert("Save failed. Please check internet or use screenshot.");
        });
    }

    function shareTwitter() {
        if(finalTop5.length === 0) return;
        const topName = finalTop5[0].name;
        const secondName = finalTop5.length > 1 ? finalTop5[1].name : "";
        let text = `My #Nogizaka46 Top 5:\n\nüëë 1. ${topName}\n`;
        if(secondName) text += `ü•à 2. ${secondName}\n`;
        if(finalTop5[2]) text += `ü•â 3. ${finalTop5[2].name}\n`;
        text += `\nFind your Oshi here:`;
        window.open("https://twitter.com/intent/tweet?text=" + encodeURIComponent(text), '_blank');
    }

    function restartSorter() {
        queue = []; history = []; currentMerge = null; battlesCount = 0;
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('result-list').innerHTML = '';
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-txt').innerText = '0%';
        document.getElementById('start-screen').classList.add('active');
        initWall();
    }

    function openModal(e, side) {
        e.stopPropagation();
        const btn = e.currentTarget;
        const name = btn.dataset.name;
        document.getElementById('m-img').src = btn.dataset.img;
        document.getElementById('m-name').innerText = name;
        document.getElementById('m-meta').innerText = `${btn.dataset.gen} ‚Ä¢ ${btn.dataset.date}`;
        const q = encodeURIComponent("Nogizaka46 " + name);
        document.getElementById('link-google').href = `https://www.google.com/search?q=${q}&tbm=isch`;
        document.getElementById('link-pinterest').href = `https://www.pinterest.com/search/pins/?q=${q}`;
        document.getElementById('link-youtube').href = `https://www.youtube.com/results?search_query=${q}`;
        document.getElementById('modal').classList.add('active');
    }
    function closeModal() { document.getElementById('modal').classList.remove('active'); }
    function handleError(img) { 
        // Set a fallback image instead of fading out
        img.src = "https://placehold.co/400x533/e0dce0/7e1083?text=No+Image";
    }

    init();
</script>
</body>
</html>
